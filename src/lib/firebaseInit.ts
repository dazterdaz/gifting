import { 
  collection, 
  doc, 
  setDoc, 
  getDoc,
  Timestamp 
} from './firebase';
import { db } from './firebase';

import { 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword 
} from './firebase';
import { auth } from './firebase';

// Funci√≥n para crear usuario de autenticaci√≥n si no existe
export const ensureAuthUser = async () => {
  try {
    console.log('üë§ Verificando/creando usuario de autenticaci√≥n...');
    
    const email = 'demian.83@hotmail.es';
    const password = '@Llamasami1';
    
    try {
      // Intentar crear el usuario
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      console.log('‚úÖ Usuario de autenticaci√≥n creado:', userCredential.user.uid);
      
      // Crear documento de usuario en Firestore
      const userRef = doc(db, 'users', userCredential.user.uid);
      await setDoc(userRef, {
        username: 'demian',
        email: email,
        role: 'superadmin',
        createdAt: Timestamp.now(),
        lastLogin: Timestamp.now(),
        isActive: true
      });
      
      console.log('‚úÖ Documento de usuario creado en Firestore');
      
      // Cerrar sesi√≥n despu√©s de crear
      await auth.signOut();
      console.log('üëã Sesi√≥n cerrada despu√©s de crear usuario');
      
      return userCredential.user;
      
    } catch (createError) {
      if (createError.code === 'auth/email-already-in-use') {
        console.log('‚ÑπÔ∏è Usuario de autenticaci√≥n ya existe, verificando documento...');
        
        // Verificar que el documento de Firestore tambi√©n existe
        try {
          const signInResult = await signInWithEmailAndPassword(auth, email, password);
          const currentUser = signInResult.user;
          
          if (currentUser) {
            const userRef = doc(db, 'users', currentUser.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
              console.log('üìù Creando documento de usuario faltante en Firestore...');
              await setDoc(userRef, {
                username: 'demian',
                email: email,
                role: 'superadmin',
                createdAt: Timestamp.now(),
                lastLogin: Timestamp.now(),
                isActive: true
              });
              console.log('‚úÖ Documento de usuario creado en Firestore');
            } else {
              console.log('‚ÑπÔ∏è Documento de usuario ya existe en Firestore');
            }
            
            // Cerrar sesi√≥n despu√©s de verificar/crear
            await auth.signOut();
            console.log('üëã Sesi√≥n cerrada despu√©s de verificaci√≥n');
            return currentUser;
          }
        } catch (signInError) {
          if (signInError.code === 'auth/wrong-password') {
            console.error('‚ùå Contrase√±a incorrecta para usuario existente');
            console.log('üîß Puede que necesites resetear la contrase√±a en Firebase Console');
          } else {
            console.warn('‚ö†Ô∏è Error verificando usuario existente:', signInError);
          }
        }
      } else {
        console.error('‚ùå Error creando usuario de autenticaci√≥n:', createError);
      }
    }
    return null;
    
  } catch (error) {
    console.error('‚ùå Error inicializando usuario de autenticaci√≥n:', error);
    return null;
  }
};

// Funci√≥n para verificar la conectividad con Firebase
export const checkFirebaseConnection = async () => {
  try {
    const testRef = doc(db, 'test', 'connection');
    await setDoc(testRef, { 
      timestamp: Timestamp.now(),
      test: true 
    });
    
    const testSnap = await getDoc(testRef);
    
    if (testSnap.exists()) {
      console.log('‚úÖ Conexi√≥n con Firebase establecida correctamente');
      return true;
    } else {
      throw new Error('No se pudo verificar la conexi√≥n');
    }
  } catch (error) {
    console.error('‚ùå Error de conexi√≥n con Firebase:', error);
    return false;
  }
};

// Funci√≥n para inicializar configuraci√≥n b√°sica
export const initializeBasicSettings = async () => {
  try {
    console.log('‚öôÔ∏è Inicializando configuraci√≥n b√°sica...');
    
    const settingsRef = doc(db, 'settings', 'site-config');
    const settingsSnap = await getDoc(settingsRef);
    
    if (!settingsSnap.exists()) {
      console.log('üìù Creando configuraci√≥n por defecto...');
      
      const defaultSettings = {
        siteName: 'Daz Giftcard Register',
        logoUrl: '/logo.svg',
        logoColor: '#4F46E5',
        terms: {
          id: 'default-terms',
          content: `
            <h3>T√©rminos y Condiciones - Daz Giftcard Register</h3>
            
            <h4>1. Aceptaci√≥n de los T√©rminos</h4>
            <p>Al utilizar este sistema de consulta de tarjetas de regalo, usted acepta estar sujeto a estos t√©rminos y condiciones.</p>
            
            <h4>2. Uso del Sistema</h4>
            <p>Este sistema est√° dise√±ado para consultar el estado y validez de las tarjetas de regalo emitidas por Daz Tattoo.</p>
            
            <h4>3. Privacidad</h4>
            <p>La informaci√≥n consultada es confidencial y solo se muestra informaci√≥n b√°sica del estado de la tarjeta.</p>
            
            <h4>4. Validez de las Tarjetas</h4>
            <p>Las tarjetas de regalo tienen una validez de 90 d√≠as desde su fecha de entrega.</p>
            
            <h4>5. Contacto</h4>
            <p>Para cualquier consulta adicional, contacte directamente con Daz Tattoo.</p>
          `,
          createdAt: Timestamp.now(),
          createdBy: 'Sistema',
          isActive: true
        },
        contactInfo: {
          phone: '+56 9 1234 5678',
          whatsapp: '+56 9 1234 5678',
          email: 'contacto@daztattoo.cl',
          address: 'Santiago, Chile'
        },
        testimonials: [
          {
            id: '1',
            name: 'Mar√≠a Gonz√°lez',
            text: '¬°Incre√≠ble experiencia! El regalo perfecto para mi hermana. El proceso fue s√∫per f√°cil.',
            rating: 5,
            avatar: 'https://images.pexels.com/photos/774909/pexels-photo-774909.jpeg?auto=compress&cs=tinysrgb&w=150'
          },
          {
            id: '2',
            name: 'Carlos Ruiz',
            text: 'Regal√© una giftcard para un tatuaje y qued√≥ espectacular. Muy profesionales.',
            rating: 5,
            avatar: 'https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?auto=compress&cs=tinysrgb&w=150'
          },
          {
            id: '3',
            name: 'Ana L√≥pez',
            text: 'El mejor regalo que he recibido. Mi piercing qued√≥ perfecto y el trato fue excelente.',
            rating: 5,
            avatar: 'https://images.pexels.com/photos/415829/pexels-photo-415829.jpeg?auto=compress&cs=tinysrgb&w=150'
          }
        ],
        socialLinks: [
          { id: '1', platform: 'Instagram', url: 'https://instagram.com/daztattoo', icon: 'instagram' },
          { id: '2', platform: 'Facebook', url: 'https://facebook.com/daztattoo', icon: 'facebook' },
          { id: '3', platform: 'WhatsApp', url: 'https://wa.me/56912345678', icon: 'whatsapp' }
        ],
        createdAt: Timestamp.now(),
        updatedAt: Timestamp.now()
      };
      
      await setDoc(settingsRef, defaultSettings);
      console.log('‚úÖ Configuraci√≥n por defecto creada');
    } else {
      console.log('‚ÑπÔ∏è Configuraci√≥n ya existe');
    }
    
    return true;
  } catch (error) {
    console.error('‚ùå Error inicializando configuraci√≥n:', error);
    return false;
  }
};

// Funci√≥n principal de inicializaci√≥n
export const initializeFirebaseCollections = async () => {
  try {
    console.log('üîÑ Inicializando Firebase...');
    
    // 1. Verificar conexi√≥n
    const isConnected = await checkFirebaseConnection();
    if (!isConnected) {
      console.warn('‚ö†Ô∏è No se pudo establecer conexi√≥n con Firebase');
      return false;
    }
    
    // 2. Crear usuario de autenticaci√≥n
    await ensureAuthUser();
    
    // 3. Inicializar configuraci√≥n b√°sica
    await initializeBasicSettings();
    
    console.log('üéâ Firebase inicializado correctamente');
    return true;
    
  } catch (error) {
    console.error('‚ùå Error inicializando Firebase:', error);
    return false;
  }
};

// Estructura de las colecciones para referencia
export const COLLECTIONS = {
  GIFTCARDS: 'giftcards',
  ACTIVITIES: 'activities',
  USERS: 'users',
  CONTACT_MESSAGES: 'contactMessages',
  SETTINGS: 'settings'
};

export default {
  initializeFirebaseCollections,
  checkFirebaseConnection,
  ensureAuthUser,
  COLLECTIONS
};